/**
 * Firestore Security Rules for Marketplace Module
 * 
 * Rules enforce:
 * - Users can only edit their own profiles
 * - Only listing owner can edit listing
 * - Orders: only buyer can create; only participants can read
 * - Messages: only participants can write/read
 * - Disputes: only participants + admin can update
 */

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isValidTimestamp(field) {
      return field is timestamp;
    }

    function isValidListingCreate() {
      return isAuthenticated()
        && request.resource.data.sellerId == request.auth.uid
        && request.resource.data.phoneNumber is string
        && request.resource.data.phoneNumber.size() > 0
        && request.resource.data.status == 'active';
    }

    function isListingReviewAggregateUpdate() {
      return isAuthenticated()
        && request.resource.data.diff(resource.data)
          .affectedKeys()
          .hasOnly(['avgRating', 'reviewCount', 'latestReviewSnippet', 'latestReviewAt'])
        && request.resource.data.avgRating is number
        && request.resource.data.reviewCount is number
        && request.resource.data.latestReviewSnippet is string
        && request.resource.data.latestReviewSnippet.size() <= 80
        && isValidTimestamp(request.resource.data.latestReviewAt);
    }

    function isListingPendingUpdateRequest() {
      return isAuthenticated()
        && resource.data.sellerId == request.auth.uid
        && request.resource.data.sellerId == resource.data.sellerId
        && request.resource.data.diff(resource.data)
          .affectedKeys()
          .hasOnly(['status', 'lastEditRequestId', 'updatedAt'])
        && request.resource.data.status == 'pending_update';
    }

    function isValidListingEditCreate() {
      return isAuthenticated()
        && request.resource.data.sellerId == request.auth.uid
        && request.resource.data.status == 'pending'
        && request.resource.data.listingId is string
        && request.resource.data.patch is map
        && isValidTimestamp(request.resource.data.submittedAt)
        && isValidTimestamp(request.resource.data.reviewAfterAt);
    }

    function isValidReviewRating(value) {
      return value is number && value >= 1 && value <= 5;
    }

    function isValidReviewComment(value) {
      return value is string && value.size() <= 500;
    }

    function isValidReviewCreate(listingId, buyerId) {
      let listing = get(/databases/$(database)/documents/listings/$(listingId)).data;
      return isAuthenticated()
        && listing != null
        && request.resource.data.listingId == listingId
        && request.resource.data.sellerId == listing.sellerId
        && request.resource.data.buyerId == buyerId
        && request.resource.data.buyerId == request.auth.uid
        && request.resource.data.buyerName is string
        && isValidReviewRating(request.resource.data.rating)
        && isValidReviewComment(request.resource.data.comment)
        && isValidTimestamp(request.resource.data.createdAt);
    }

    function hasOrderItems(data) {
      return ('items' in data) && data.items is list && data.items.size() > 0;
    }

    function hasValidOrderTotals(data) {
      return ('totalAmount' in data) && data.totalAmount is number && data.totalAmount > 0;
    }

    function hasValidOrderQuantity(data) {
      return !('quantity' in data) || (data.quantity is number && data.quantity > 0);
    }

    function hasOrderItemsOrQuantity(data) {
      return hasOrderItems(data) || ('quantity' in data);
    }
    
    // Helper function to check if user owns a document
    function isOwner(userIdField) {
      return isAuthenticated() && 
             resource.data[userIdField] == request.auth.uid;
    }
    
    // ============================================================================
    // USERS COLLECTION
    // ============================================================================
    match /users/{userId} {
      // Users can read any profile
      allow read: if isAuthenticated();
      
      // Users can only update their own profile
      allow update: if isAuthenticated() && 
                      request.auth.uid == userId &&
                      // Prevent role changes (only admin can change roles)
                      (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']) ||
                       isAdmin());
      
      // Only admins can create/delete user documents
      allow create, delete: if isAdmin();
    }
    
    // ============================================================================
    // LISTINGS COLLECTION
    // ============================================================================
    match /listings/{listingId} {
      // Authenticated users can read listings
      allow read: if isAuthenticated();
      
      // Only listing owner can create/update/delete
      allow create: if isValidListingCreate();
      
      allow update: if isListingReviewAggregateUpdate() || isListingPendingUpdateRequest();
      
      allow delete: if false;

      match /reviews/{buyerId} {
        allow read: if isAuthenticated();
        allow create: if isValidReviewCreate(listingId, buyerId);
        allow update, delete: if false;
      }
    }

    match /listingEdits/{editId} {
      allow read: if isAuthenticated() && resource.data.sellerId == request.auth.uid;
      allow create: if isValidListingEditCreate();
      allow update, delete: if false;
    }
    
    // ============================================================================
    // ORDERS COLLECTION
    // ============================================================================
    match /orders/{orderId} {
      // Only buyer, seller, or admin can read order
      allow read: if isAuthenticated() && 
                     (resource.data.buyerId == request.auth.uid ||
                      resource.data.sellerId == request.auth.uid ||
                      isAdmin());
      
      // Only buyer can create order
      allow create: if isAuthenticated() && 
                       request.resource.data.buyerId == request.auth.uid &&
                       request.resource.data.status in ['pending', 'pending_payment'] &&
                       hasValidOrderTotals(request.resource.data) &&
                       hasValidOrderQuantity(request.resource.data) &&
                       hasOrderItemsOrQuantity(request.resource.data);
      
      // Seller can update order to mark as shipped
      allow update: if isAuthenticated() && 
                       (resource.data.sellerId == request.auth.uid ||
                        resource.data.buyerId == request.auth.uid ||
                        isAdmin()) &&
                       // Enforce status transitions
                       (request.resource.data.status == resource.data.status ||
                        // Seller can mark as shipped
                        (resource.data.sellerId == request.auth.uid && 
                         request.resource.data.status == 'shipped' &&
                         resource.data.status == 'paid_in_escrow') ||
                        // Buyer can confirm delivery
                        (resource.data.buyerId == request.auth.uid && 
                         request.resource.data.status == 'delivered' &&
                         resource.data.status == 'shipped') ||
                        // Admin can change any status
                        isAdmin()) &&
                       hasValidOrderTotals(request.resource.data) &&
                       hasValidOrderQuantity(request.resource.data) &&
                       hasOrderItemsOrQuantity(request.resource.data);
      
      // Only admin can delete orders
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // TRANSACTIONS COLLECTION
    // ============================================================================
    match /transactions/{transactionId} {
      // Only order participants or admin can read
      allow read: if isAuthenticated() && 
                     (get(/databases/$(database)/documents/orders/$(resource.data.orderId)).data.buyerId == request.auth.uid ||
                      get(/databases/$(database)/documents/orders/$(resource.data.orderId)).data.sellerId == request.auth.uid ||
                      isAdmin());
      
      // Only Cloud Functions can create/update transactions
      allow create, update: if false; // Enforced via Cloud Functions
      
      // Only admin can delete
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // CHATS COLLECTION
    // ============================================================================
    match /chats/{chatId} {
      // Only participants can read chat
      allow read: if isAuthenticated() && 
                     request.auth.uid in resource.data.participants;
      
      // Participants can create/update chat
      allow create: if isAuthenticated() && 
                       request.auth.uid in request.resource.data.participants;
      
      allow update: if isAuthenticated() && 
                       (request.auth.uid in resource.data.participants ||
                        // Allow typing indicator updates
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['typing', 'updatedAt']));
      
      // Only participants can delete
      allow delete: if isAuthenticated() && 
                       request.auth.uid in resource.data.participants;
      
      // Messages subcollection
      match /messages/{messageId} {
        // Only chat participants can read messages
        allow read: if isAuthenticated() && 
                       request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // Only sender can create message
        allow create: if isAuthenticated() && 
                         request.resource.data.senderId == request.auth.uid &&
                         request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // Only sender can update their own messages
        allow update: if isAuthenticated() && 
                         resource.data.senderId == request.auth.uid;
        
        // Only sender can delete their own messages
        allow delete: if isAuthenticated() && 
                         resource.data.senderId == request.auth.uid;
      }
    }
    
    // ============================================================================
    // RATINGS COLLECTION
    // ============================================================================
    match /ratings/{ratingId} {
      // Anyone can read ratings
      allow read: if isAuthenticated();
      
      // Only rater can create rating, and must have valid order
      allow create: if isAuthenticated() && 
                       request.resource.data.fromUserId == request.auth.uid &&
                       // Verify order exists and user is participant
                       (exists(/databases/$(database)/documents/orders/$(request.resource.data.orderId)) &&
                        (get(/databases/$(database)/documents/orders/$(request.resource.data.orderId)).data.buyerId == request.auth.uid ||
                         get(/databases/$(database)/documents/orders/$(request.resource.data.orderId)).data.sellerId == request.auth.uid));
      
      // Only rater can update their own rating
      allow update: if isAuthenticated() && 
                       resource.data.fromUserId == request.auth.uid;
      
      // Only admin can delete
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // DISPUTES COLLECTION
    // ============================================================================
    match /disputes/{disputeId} {
      // Only participants or admin can read
      allow read: if isAuthenticated() && 
                     (get(/databases/$(database)/documents/orders/$(resource.data.orderId)).data.buyerId == request.auth.uid ||
                      get(/databases/$(database)/documents/orders/$(resource.data.orderId)).data.sellerId == request.auth.uid ||
                      isAdmin());
      
      // Only order participants can create dispute
      allow create: if isAuthenticated() && 
                       (get(/databases/$(database)/documents/orders/$(request.resource.data.orderId)).data.buyerId == request.auth.uid ||
                        get(/databases/$(database)/documents/orders/$(request.resource.data.orderId)).data.sellerId == request.auth.uid) &&
                       request.resource.data.raisedBy == request.auth.uid;
      
      // Only dispute raiser or admin can update
      allow update: if isAuthenticated() && 
                       (resource.data.raisedBy == request.auth.uid || isAdmin());
      
      // Only admin can delete
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // NOTIFICATIONS COLLECTION
    // ============================================================================
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      // Only system (Cloud Functions) can create notifications
      allow create: if false; // Enforced via Cloud Functions
      
      // Users can update their own notifications (mark as read)
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid &&
                       // Only allow updating read status
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
      
      // Users can delete their own notifications
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }
  }
}
