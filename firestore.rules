/**
 * Firestore Security Rules for Harvest Module
 * 
 * Features:
 * - Multi-tenant authentication using user.uid
 * - Read/Write access only to authenticated owner
 * - Prevents data access across users
 * - Validates data structure on write
 */

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================================================
    // HELPER FUNCTIONS
    // ========================================================================
    
    /**
     * Check if user is authenticated
     */
    function isAuthenticated() {
      return request.auth != null;
    }
    
    /**
     * Check if user owns the resource (single-tenant)
     */
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    /**
     * Validate common harvest document structure
     */
    function isValidTimestamp(field) {
      return field is timestamp;
    }

    /**
     * Check if the current user owns the referenced crop
     */
    function ownsCrop(cropId) {
      return isAuthenticated()
        && get(/databases/$(database)/documents/crops/$(cropId)).data.userId == request.auth.uid;
    }

    /**
     * Check if the current user owns the referenced farm
     */
    function ownsFarm(farmId) {
      return isAuthenticated()
        && get(/databases/$(database)/documents/farms/$(farmId)).data.uid == request.auth.uid;
    }

    /**
     * Validate farm data on create
     */
    function isValidFarmCreate(data) {
      return data.keys().hasAll(['uid', 'name', 'county', 'ward', 'lat', 'lon', 'createdAt'])
        && data.uid is string
        && data.name is string && data.name.size() > 0
        && data.county is string && data.county.size() > 0
        && data.ward is string && data.ward.size() > 0
        && data.lat is number
        && data.lon is number
        && (!('elevation' in data) || data.elevation is number)
        && isValidTimestamp(data.createdAt);
    }
    
    // ========================================================================
    // HARVEST COLLECTION (USER-SCOPED)
    // ========================================================================
    
    match /users/{userId}/harvest/{harvestId}/{document=**} {
      // Deny all access by default
      allow read, write: if false;
    }

    // ========================================================================
    // USER PROFILE (CLIMATE PLAN + FEATURES)
    // ========================================================================

    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }

    // ========================================================================
    // FARMS (CLIMATE LOCATIONS)
    // ========================================================================

    match /farms/{farmId} {
      allow create: if isAuthenticated()
        && request.resource.data.uid == request.auth.uid
        && isValidFarmCreate(request.resource.data);
      allow get: if isAuthenticated()
        && resource.data.uid == request.auth.uid;
      allow list: if isAuthenticated()
        && request.query.where("uid", "==", request.auth.uid);
      allow update: if isAuthenticated()
        && resource.data.uid == request.auth.uid
        && request.resource.data.uid == resource.data.uid;
      allow delete: if isAuthenticated()
        && resource.data.uid == request.auth.uid;
    }

    // ========================================================================
    // CLIMATE CACHE (READ ONLY)
    // ========================================================================

    match /climateCache/{cacheId} {
      allow read: if isAuthenticated() && resource.data.uid == request.auth.uid;
      allow write: if false;
    }

    // ========================================================================
    // ALERT SUBSCRIPTIONS (PER USER)
    // ========================================================================

    match /alertSubscriptions/{userId} {
      allow read, write: if isOwner(userId);
    }

    match /alerts/{userId}/items/{alertId} {
      allow read, write: if isOwner(userId);
    }

    // ========================================================================
    // CROPS (SENTINEL AGENT)
    // ========================================================================

    match /crops/{cropId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if isOwner(request.resource.data.userId);
      allow update: if isOwner(resource.data.userId)
        && request.resource.data.userId == resource.data.userId;
      allow delete: if isOwner(resource.data.userId);
      allow list: if isAuthenticated();
    }

    match /cropActivities/{activityId} {
      allow read: if ownsCrop(resource.data.cropId);
      allow create: if ownsCrop(request.resource.data.cropId);
      allow update: if ownsCrop(resource.data.cropId);
      allow delete: if ownsCrop(resource.data.cropId);
      allow list: if isAuthenticated();
    }

    match /cropRecommendations/{recommendationId} {
      allow read: if ownsCrop(resource.data.cropId);
      allow create: if ownsCrop(request.resource.data.cropId);
      allow update: if ownsCrop(resource.data.cropId);
      allow delete: if ownsCrop(resource.data.cropId);
      allow list: if isAuthenticated();
    }

    match /cropGrowthData/{growthId} {
      allow read: if ownsCrop(resource.data.cropId);
      allow create: if ownsCrop(request.resource.data.cropId);
      allow update: if ownsCrop(resource.data.cropId);
      allow delete: if ownsCrop(resource.data.cropId);
      allow list: if isAuthenticated();
    }
    
    // ========================================================================
    // HARVEST SCHEDULES
    // ========================================================================
    
    match /users/{userId}/harvest/{harvestId}/schedules/{scheduleId} {
      
      // Read: Owner only
      allow read: if isOwner(userId);
      
      // Create: Owner only, with validation
      allow create: if isOwner(userId)
        && request.resource.data.userId == userId
        && request.resource.data.keys().hasAll(['cropId', 'farmId', 'cropName', 'field', 'plantedDate', 'estimatedReadyDate', 'status', 'expectedYield', 'yieldUnit'])
        && request.resource.data.status in ['Pending', 'Ready', 'InProgress', 'Harvested', 'Cancelled']
        && request.resource.data.expectedYield > 0
        && isValidTimestamp(request.resource.data.createdAt)
        && isValidTimestamp(request.resource.data.updatedAt);
      
      // Update: Owner only, preserve userId
      allow update: if isOwner(userId)
        && resource.data.userId == userId
        && request.resource.data.userId == userId
        && isValidTimestamp(request.resource.data.updatedAt);
      
      // Delete: Owner only
      allow delete: if isOwner(userId)
        && resource.data.userId == userId;
      
      // List
      allow list: if isOwner(userId);
    }
    
    // ========================================================================
    // WORKERS
    // ========================================================================
    
    match /users/{userId}/harvest/{harvestId}/workers/{workerId} {
      
      // Read: Owner only
      allow read: if isOwner(userId);
      
      // Create: Owner only, with validation
      allow create: if isOwner(userId)
        && request.resource.data.userId == userId
        && request.resource.data.keys().hasAll(['name', 'role', 'phone', 'status'])
        && request.resource.data.role in ['Harvester', 'Supervisor', 'Transporter', 'Quality Inspector']
        && request.resource.data.status in ['Active', 'Inactive']
        && request.resource.data.name.size() > 0
        && request.resource.data.phone.size() > 0
        && request.resource.data.assignedScheduleIds is list
        && isValidTimestamp(request.resource.data.createdAt)
        && isValidTimestamp(request.resource.data.updatedAt);
      
      // Update: Owner only, preserve userId
      allow update: if isOwner(userId)
        && resource.data.userId == userId
        && request.resource.data.userId == userId
        && isValidTimestamp(request.resource.data.updatedAt);
      
      // Delete: Owner only
      allow delete: if isOwner(userId)
        && resource.data.userId == userId;
      
      // List
      allow list: if isOwner(userId);
    }
    
    // ========================================================================
    // DELIVERIES
    // ========================================================================
    
    match /users/{userId}/harvest/{harvestId}/deliveries/{deliveryId} {
      
      // Read: Owner only
      allow read: if isOwner(userId);
      
      // Create: Owner only, with validation
      allow create: if isOwner(userId)
        && request.resource.data.userId == userId
        && request.resource.data.keys().hasAll(['scheduleId', 'assignedWorkerId', 'destination', 'destinationAddress', 'quantity', 'quantityUnit', 'scheduledDate', 'status', 'vehicleType'])
        && request.resource.data.destination in ['Market', 'Warehouse', 'Buyer', 'Processor', 'Other']
        && request.resource.data.status in ['Pending', 'InTransit', 'Delivered', 'Cancelled', 'Delayed']
        && request.resource.data.vehicleType in ['Truck', 'Van', 'Motorbike', 'Bicycle', 'Other']
        && request.resource.data.quantity > 0
        && isValidTimestamp(request.resource.data.createdAt)
        && isValidTimestamp(request.resource.data.updatedAt);
      
      // Update: Owner only, preserve userId
      allow update: if isOwner(userId)
        && resource.data.userId == userId
        && request.resource.data.userId == userId
        && isValidTimestamp(request.resource.data.updatedAt);
      
      // Delete: Owner only
      allow delete: if isOwner(userId)
        && resource.data.userId == userId;
      
      // List
      allow list: if isOwner(userId);
    }
  }
}
