/**
 * Firestore Security Rules for Harvest Module
 * 
 * Features:
 * - Multi-tenant authentication using user.uid
 * - Read/Write access only to authenticated owner
 * - Prevents data access across users
 * - Validates data structure on write
 */

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================================================
    // HELPER FUNCTIONS
    // ========================================================================
    
    /**
     * Check if user is authenticated
     */
    function isAuthenticated() {
      return request.auth != null;
    }
    
    /**
     * Check if user owns the resource (single-tenant)
     */
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    /**
     * Check if user is admin (best-effort; false if profile missing)
     */
    function isAdmin() {
      return isAuthenticated()
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    /**
     * Validate common harvest document structure
     */
    function isValidTimestamp(field) {
      return field is timestamp;
    }

    function isValidListingCreate() {
      return isAuthenticated()
        && request.resource.data.sellerId == request.auth.uid
        && request.resource.data.phoneNumber is string
        && request.resource.data.phoneNumber.size() > 0
        && request.resource.data.status == 'active';
    }

    function isListingReviewAggregateUpdate() {
      return isAuthenticated()
        && request.resource.data.diff(resource.data)
        .affectedKeys()
        .hasOnly(['avgRating', 'reviewCount', 'latestReviewSnippet', 'latestReviewAt'])
        && request.resource.data.avgRating is number
        && request.resource.data.reviewCount is number
        && request.resource.data.latestReviewSnippet is string
        && request.resource.data.latestReviewSnippet.size() <= 80
        && isValidTimestamp(request.resource.data.latestReviewAt);
    }

    function isListingPendingUpdateRequest() {
      return isAuthenticated()
        && resource.data.sellerId == request.auth.uid
        && request.resource.data.sellerId == resource.data.sellerId
        && request.resource.data.diff(resource.data)
          .affectedKeys()
          .hasOnly(['status', 'lastEditRequestId', 'updatedAt'])
        && request.resource.data.status == 'pending_update';
    }

    function isValidListingEditCreate() {
      return isAuthenticated()
        && request.resource.data.sellerId == request.auth.uid
        && request.resource.data.status == 'pending'
        && request.resource.data.listingId is string
        && request.resource.data.patch is map
        && isValidTimestamp(request.resource.data.submittedAt)
        && isValidTimestamp(request.resource.data.reviewAfterAt);
    }

    /**
     * Check if the current user owns the referenced crop
     */
    function ownsCrop(cropId) {
      return isAuthenticated()
        && get(/databases/$(database)/documents/crops/$(cropId)).data.userId == request.auth.uid;
    }

    /**
     * Check if the current user owns the referenced farm
     */
    function ownsFarm(farmId) {
      return isAuthenticated()
        && get(/databases/$(database)/documents/farms/$(farmId)).data.uid == request.auth.uid;
    }

    /**
     * Validate farm data on create
     */
    function isValidFarmCreate(data) {
      return data.keys().hasAll(['uid', 'name', 'county', 'ward', 'lat', 'lon', 'createdAt'])
        && data.uid is string
        && data.name is string && data.name.size() > 0
        && data.county is string && data.county.size() > 0
        && data.ward is string && data.ward.size() > 0
        && data.lat is number
        && data.lon is number
        && (!('elevation' in data) || data.elevation is number)
        && isValidTimestamp(data.createdAt);
    }
    
    // ========================================================================
    // HARVEST COLLECTION (USER-SCOPED)
    // ========================================================================
    
    match /users/{userId}/harvest/{harvestId}/{document=**} {
      // Deny all access by default
      allow read, write: if false;
    }

    // ========================================================================
    // USER PROFILE (CLIMATE PLAN + FEATURES)
    // ========================================================================

    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }

    // ========================================================================
    // FARMER PROFILES
    // ========================================================================

    match /farmers/{userId} {
      allow read, write: if isOwner(userId);
    }

    match /farmers/{userId}/pendingUpdates/{pendingId} {
      allow read, write: if isOwner(userId);
    }

    // ========================================================================
    // FARMS (CLIMATE LOCATIONS)
    // ========================================================================

    match /farms/{farmId} {
      allow create: if isAuthenticated()
        && request.resource.data.uid == request.auth.uid
        && isValidFarmCreate(request.resource.data);
      allow get: if isAuthenticated()
        && resource.data.uid == request.auth.uid;
      allow list: if isAuthenticated()
        && request.query.where("uid", "==", request.auth.uid);
      allow update: if isAuthenticated()
        && resource.data.uid == request.auth.uid
        && request.resource.data.uid == resource.data.uid;
      allow delete: if isAuthenticated()
        && resource.data.uid == request.auth.uid;
    }

    // ========================================================================
    // CLIMATE CACHE (READ ONLY)
    // ========================================================================

    match /climateCache/{cacheId} {
      allow read: if isAuthenticated() && resource.data.uid == request.auth.uid;
      allow write: if false;
    }

    // ========================================================================
    // ALERT SUBSCRIPTIONS (PER USER)
    // ========================================================================

    match /alertSubscriptions/{userId} {
      allow read, write: if isOwner(userId);
    }

    match /alerts/{userId}/items/{alertId} {
      allow read, write: if isOwner(userId);
    }

    // ========================================================================
    // CROPS (SENTINEL AGENT)
    // ========================================================================

    match /crops/{cropId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if isOwner(request.resource.data.userId);
      allow update: if isOwner(resource.data.userId)
        && request.resource.data.userId == resource.data.userId;
      allow delete: if isOwner(resource.data.userId);
      allow list: if isAuthenticated();
    }

    // ========================================================================
    // MARKETPLACE LISTINGS
    // ========================================================================

    match /listings/{listingId} {
      // Authenticated users can read listings
      allow read: if isAuthenticated();

      // Only the authenticated seller can create their own listing with phone
      allow create: if isValidListingCreate();

      // Only allow review aggregate updates or pending edit requests
      allow update: if isListingReviewAggregateUpdate() || isListingPendingUpdateRequest();

      // Prevent direct deletes from client
      allow delete: if false;
    }

    match /cropActivities/{activityId} {
      allow read: if ownsCrop(resource.data.cropId);
      allow create: if ownsCrop(request.resource.data.cropId);
      allow update: if ownsCrop(resource.data.cropId);
      allow delete: if ownsCrop(resource.data.cropId);
      allow list: if isAuthenticated();
    }

    match /cropRecommendations/{recommendationId} {
      allow read: if ownsCrop(resource.data.cropId);
      allow create: if ownsCrop(request.resource.data.cropId);
      allow update: if ownsCrop(resource.data.cropId);
      allow delete: if ownsCrop(resource.data.cropId);
      allow list: if isAuthenticated();
    }

    match /cropGrowthData/{growthId} {
      allow read: if ownsCrop(resource.data.cropId);
      allow create: if ownsCrop(request.resource.data.cropId);
      allow update: if ownsCrop(resource.data.cropId);
      allow delete: if ownsCrop(resource.data.cropId);
      allow list: if isAuthenticated();
    }
    
    // ========================================================================
    // HARVEST SCHEDULES
    // ========================================================================
    
    match /users/{userId}/harvest/{harvestId}/schedules/{scheduleId} {
      
      // Read: Owner only
      allow read: if isOwner(userId);
      
      // Create: Owner only, with validation
      allow create: if isOwner(userId)
        && request.resource.data.userId == userId
        && request.resource.data.keys().hasAll(['cropId', 'farmId', 'cropName', 'field', 'plantedDate', 'estimatedReadyDate', 'status', 'expectedYield', 'yieldUnit'])
        && request.resource.data.status in ['Pending', 'Ready', 'InProgress', 'Harvested', 'Cancelled']
        && request.resource.data.expectedYield > 0
        && isValidTimestamp(request.resource.data.createdAt)
        && isValidTimestamp(request.resource.data.updatedAt);
      
      // Update: Owner only, preserve userId
      allow update: if isOwner(userId)
        && resource.data.userId == userId
        && request.resource.data.userId == userId
        && isValidTimestamp(request.resource.data.updatedAt);
      
      // Delete: Owner only
      allow delete: if isOwner(userId)
        && resource.data.userId == userId;
      
      // List
      allow list: if isOwner(userId);
    }
    
    // ========================================================================
    // WORKERS
    // ========================================================================
    
    match /users/{userId}/harvest/{harvestId}/workers/{workerId} {
      
      // Read: Owner only
      allow read: if isOwner(userId);
      
      // Create: Owner only, with validation
      allow create: if isOwner(userId)
        && request.resource.data.userId == userId
        && request.resource.data.keys().hasAll(['name', 'role', 'phone', 'status'])
        && request.resource.data.role in ['Harvester', 'Supervisor', 'Transporter', 'Quality Inspector']
        && request.resource.data.status in ['Active', 'Inactive']
        && request.resource.data.name.size() > 0
        && request.resource.data.phone.size() > 0
        && request.resource.data.assignedScheduleIds is list
        && isValidTimestamp(request.resource.data.createdAt)
        && isValidTimestamp(request.resource.data.updatedAt);
      
      // Update: Owner only, preserve userId
      allow update: if isOwner(userId)
        && resource.data.userId == userId
        && request.resource.data.userId == userId
        && isValidTimestamp(request.resource.data.updatedAt);
      
      // Delete: Owner only
      allow delete: if isOwner(userId)
        && resource.data.userId == userId;
      
      // List
      allow list: if isOwner(userId);
    }
    
    // ========================================================================
    // DELIVERIES
    // ========================================================================
    
    match /users/{userId}/harvest/{harvestId}/deliveries/{deliveryId} {
      
      // Read: Owner only
      allow read: if isOwner(userId);
      
      // Create: Owner only, with validation
      allow create: if isOwner(userId)
        && request.resource.data.userId == userId
        && request.resource.data.keys().hasAll(['scheduleId', 'assignedWorkerId', 'destination', 'destinationAddress', 'quantity', 'quantityUnit', 'scheduledDate', 'status', 'vehicleType'])
        && request.resource.data.destination in ['Market', 'Warehouse', 'Buyer', 'Processor', 'Other']
        && request.resource.data.status in ['Pending', 'InTransit', 'Delivered', 'Cancelled', 'Delayed']
        && request.resource.data.vehicleType in ['Truck', 'Van', 'Motorbike', 'Bicycle', 'Other']
        && request.resource.data.quantity > 0
        && isValidTimestamp(request.resource.data.createdAt)
        && isValidTimestamp(request.resource.data.updatedAt);
      
      // Update: Owner only, preserve userId
      allow update: if isOwner(userId)
        && resource.data.userId == userId
        && request.resource.data.userId == userId
        && isValidTimestamp(request.resource.data.updatedAt);
      
      // Delete: Owner only
      allow delete: if isOwner(userId)
        && resource.data.userId == userId;
      
      // List
      allow list: if isOwner(userId);
    }

    // ========================================================================
    // MARKETPLACE HELPERS
    // ========================================================================

    function isMarketplaceStatus(status) {
      return status in ['pending', 'accepted', 'in_transit', 'completed', 'cancelled'];
    }

    function isPositiveNumber(value) {
      return value is number && value > 0;
    }

    function hasOrderItems(data) {
      return ('items' in data) && data.items is list && data.items.size() > 0;
    }

    function hasValidOrderTotals(data) {
      return ('totalAmount' in data) && isPositiveNumber(data.totalAmount);
    }

    function hasValidOrderQuantity(data) {
      return !('quantity' in data) || isPositiveNumber(data.quantity);
    }

    function hasOrderItemsOrQuantity(data) {
      return hasOrderItems(data) || ('quantity' in data);
    }

    function hasValidTimestamps(data) {
      return isValidTimestamp(data.createdAt) && isValidTimestamp(data.updatedAt);
    }

    function isValidReviewRating(value) {
      return value is number && value >= 1 && value <= 5;
    }

    function isValidReviewComment(value) {
      return value is string && value.size() <= 500;
    }

    function isValidReviewCreate(listingId, buyerId) {
      let listing = get(/databases/$(database)/documents/listings/$(listingId)).data;
      return isAuthenticated()
        && listing != null
        && request.resource.data.listingId == listingId
        && request.resource.data.sellerId == listing.sellerId
        && request.resource.data.buyerId == buyerId
        && request.resource.data.buyerId == request.auth.uid
        && request.resource.data.buyerName is string
        && isValidReviewRating(request.resource.data.rating)
        && isValidReviewComment(request.resource.data.comment)
        && isValidTimestamp(request.resource.data.createdAt);
    }

    // ========================================================================
    // MARKETPLACE LISTINGS (APPENDED)
    // ========================================================================

    match /listings/{listingId} {
      // Authenticated users can read listings
      allow read: if isAuthenticated();

      // Only authenticated sellers can create their own listing
      allow create: if isValidListingCreate()
        && hasValidTimestamps(request.resource.data)
        && (!('quantity' in request.resource.data) || isPositiveNumber(request.resource.data.quantity));

      // Only allow review aggregate updates or pending edit requests
      allow update: if isListingReviewAggregateUpdate() || isListingPendingUpdateRequest();

      // Prevent direct deletes from client
      allow delete: if false;

      match /reviews/{buyerId} {
        allow read: if isAuthenticated();
        allow create: if isValidReviewCreate(listingId, buyerId);
        allow update, delete: if false;
      }
    }

    match /listingEdits/{editId} {
      allow read: if isAuthenticated() && resource.data.sellerId == request.auth.uid;
      allow create: if isValidListingEditCreate();
      allow update, delete: if false;
    }

    // ========================================================================
    // MARKETPLACE ORDERS (APPENDED)
    // ========================================================================

    match /orders/{orderId} {
      // Only buyer or seller can read orders
      allow read: if isAuthenticated()
        && (resource.data.buyerId == request.auth.uid || resource.data.sellerId == request.auth.uid);

      // Only authenticated buyers can create orders for themselves with valid data
      allow create: if isAuthenticated()
        && request.resource.data.buyerId == request.auth.uid
        && hasValidTimestamps(request.resource.data)
        && hasValidOrderTotals(request.resource.data)
        && hasValidOrderQuantity(request.resource.data)
        && hasOrderItemsOrQuantity(request.resource.data)
        && isMarketplaceStatus(request.resource.data.status);

      // Buyer or seller can update, but buyerId/sellerId/createdAt are immutable
      allow update: if isAuthenticated()
        && (resource.data.buyerId == request.auth.uid || resource.data.sellerId == request.auth.uid)
        && request.resource.data.buyerId == resource.data.buyerId
        && request.resource.data.sellerId == resource.data.sellerId
        && request.resource.data.createdAt == resource.data.createdAt
        && isValidTimestamp(request.resource.data.updatedAt)
        && hasValidOrderTotals(request.resource.data)
        && hasValidOrderQuantity(request.resource.data)
        && hasOrderItemsOrQuantity(request.resource.data)
        && isMarketplaceStatus(request.resource.data.status);

      // Orders cannot be deleted
      allow delete: if false;
    }
  }
}
