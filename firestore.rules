/**
 * Firestore Security Rules for Harvest Module
 * 
 * Features:
 * - Multi-tenant authentication using user.uid
 * - Read/Write access only to authenticated owner
 * - Prevents data access across users
 * - Validates data structure on write
 */

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================================================
    // HELPER FUNCTIONS
    // ========================================================================
    
    /**
     * Check if user is authenticated
     */
    function isAuthenticated() {
      return request.auth != null;
    }
    
    /**
     * Check if user owns the resource (single-tenant)
     */
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    /**
     * Check if user is admin (best-effort; false if profile missing)
     */
    function isAdmin() {
      return isAuthenticated()
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isSuperAdmin() {
      return isAuthenticated()
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin';
    }

    function userRole() {
      return isAuthenticated()
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role
        : null;
    }

    function userOrgId() {
      return isAuthenticated()
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgId
        : null;
    }

    function isOrgMember(orgId) {
      return isAuthenticated()
        && (exists(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid))
          || exists(/databases/$(database)/documents/orgs/$(orgId)/members/$(request.auth.uid))
          || exists(/databases/$(database)/documents/orgs/$(orgId)/memberships/$(request.auth.uid)));
    }

    function isOrgAdmin(orgId) {
      return isAuthenticated()
        && ((exists(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid))
            && get(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid)).data.role == 'admin')
          || (exists(/databases/$(database)/documents/orgs/$(orgId)/members/$(request.auth.uid))
            && get(/databases/$(database)/documents/orgs/$(orgId)/members/$(request.auth.uid)).data.role in ['org_admin', 'admin'])
          || (exists(/databases/$(database)/documents/orgs/$(orgId)/memberships/$(request.auth.uid))
            && get(/databases/$(database)/documents/orgs/$(orgId)/memberships/$(request.auth.uid)).data.role == 'org_admin'));
    }

    function isOrgStaff(orgId) {
      return isAuthenticated()
        && ((exists(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid))
            && get(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid)).data.role == 'staff')
          || (exists(/databases/$(database)/documents/orgs/$(orgId)/members/$(request.auth.uid))
            && get(/databases/$(database)/documents/orgs/$(orgId)/members/$(request.auth.uid)).data.role in ['org_staff', 'staff'])
          || (exists(/databases/$(database)/documents/orgs/$(orgId)/memberships/$(request.auth.uid))
            && get(/databases/$(database)/documents/orgs/$(orgId)/memberships/$(request.auth.uid)).data.role == 'org_staff'));
    }

    function isOrgVerificationOnlyUpdate() {
      return request.resource.data.diff(resource.data)
        .affectedKeys()
        .hasOnly(['verificationStatus', 'verifiedAt', 'verifiedBy', 'rejectedAt', 'rejectionReason']);
    }

    function isOrgApproved(orgId) {
      return exists(/databases/$(database)/documents/orgs/$(orgId))
        && get(/databases/$(database)/documents/orgs/$(orgId)).data.verificationStatus == 'approved';
    }

    function isApprovedOrgManager(orgId) {
      return isOrgManager(orgId) && isOrgApproved(orgId);
    }
    function isOrgManager(orgId) {
      return isOrgAdmin(orgId)
        || isOrgStaff(orgId)
        || (userOrgId() == orgId && userRole() in ['org_admin', 'org_staff'])
        || isAdmin()
        || isSuperAdmin();
    }

    function isOrgAffiliated(orgId) {
      return isOrgMember(orgId)
        || (userOrgId() == orgId && userRole() in ['org_admin', 'org_staff'])
        || isAdmin()
        || isSuperAdmin();
    }

    function canStaffManageBilling(orgId) {
      return isOrgStaff(orgId)
        && exists(/databases/$(database)/documents/orgs/$(orgId)/billing/settings)
        && get(/databases/$(database)/documents/orgs/$(orgId)/billing/settings).data.staffCanManageBilling == true;
    }

    function isSeatMutation() {
      return request.resource.data.diff(resource.data)
        .affectedKeys()
        .hasAny(['seatType', 'seatStatus', 'premiumSeatType', 'seatAssignedAt', 'seatAssignedBy', 'seatAssignedByName', 'entitlement']);
    }


    function isOrgProfileUpdate() {
      return !request.resource.data.diff(resource.data)
        .affectedKeys()
        .hasAny(['verificationStatus', 'verifiedAt', 'verifiedBy', 'rejectedAt', 'rejectionReason', 'documents']);
    }

    function isOrgAdminWritingStaffProfile(userId) {
      return isAuthenticated()
        && request.resource.data.uid == userId
        && request.resource.data.role == 'org_staff'
        && request.resource.data.orgId is string
        && isOrgAdmin(request.resource.data.orgId);
    }
    
    /**
     * Validate common harvest document structure
     */
    function isValidTimestamp(field) {
      return field is timestamp;
    }

    function isValidListingCreate() {
      return isAuthenticated()
        && request.resource.data.sellerId == request.auth.uid
        && request.resource.data.phoneNumber is string
        && request.resource.data.phoneNumber.size() > 0
        && request.resource.data.status == 'active';
    }

    function isListingReviewAggregateUpdate() {
      return isAuthenticated()
        && request.resource.data.diff(resource.data)
        .affectedKeys()
        .hasOnly(['avgRating', 'reviewCount', 'latestReviewSnippet', 'latestReviewAt'])
        && request.resource.data.avgRating is number
        && request.resource.data.reviewCount is number
        && request.resource.data.latestReviewSnippet is string
        && request.resource.data.latestReviewSnippet.size() <= 80
        && isValidTimestamp(request.resource.data.latestReviewAt);
    }

    function isListingPendingUpdateRequest() {
      return isAuthenticated()
        && resource.data.sellerId == request.auth.uid
        && request.resource.data.sellerId == resource.data.sellerId
        && request.resource.data.diff(resource.data)
          .affectedKeys()
          .hasOnly(['status', 'lastEditRequestId', 'updatedAt'])
        && request.resource.data.status == 'pending_update';
    }

    function isValidListingEditCreate() {
      return isAuthenticated()
        && request.resource.data.sellerId == request.auth.uid
        && request.resource.data.status == 'pending'
        && request.resource.data.listingId is string
        && request.resource.data.patch is map
        && isValidTimestamp(request.resource.data.submittedAt)
        && isValidTimestamp(request.resource.data.reviewAfterAt);
    }

    /**
     * Check if the current user owns the referenced crop
     */
    function ownsCrop(cropId) {
      return isAuthenticated()
        && get(/databases/$(database)/documents/crops/$(cropId)).data.userId == request.auth.uid;
    }

    /**
     * Check if the current user owns the referenced farm
     */
    function ownsFarm(farmId) {
      return isAuthenticated()
        && get(/databases/$(database)/documents/farms/$(farmId)).data.uid == request.auth.uid;
    }

    /**
     * Validate farm data on create
     */
    function isValidFarmCreate(data) {
      return data.keys().hasAll(['uid', 'name', 'county', 'ward', 'lat', 'lon', 'createdAt'])
        && data.uid is string
        && data.name is string && data.name.size() > 0
        && data.county is string && data.county.size() > 0
        && data.ward is string && data.ward.size() > 0
        && data.lat is number
        && data.lon is number
        && (!('elevation' in data) || data.elevation is number)
        && isValidTimestamp(data.createdAt);
    }
    
    // ========================================================================
    // HARVEST COLLECTION (USER-SCOPED)
    // ========================================================================
    
    match /users/{userId}/harvest/{harvestId}/{document=**} {
      // Deny all access by default
      allow read, write: if false;
    }

    // ========================================================================
    // USER PROFILE (CLIMATE PLAN + FEATURES)
    // ========================================================================

    match /users/{userId} {
      allow read: if isOwner(userId) || isSuperAdmin();
      allow write: if isOwner(userId) || isSuperAdmin() || isOrgAdminWritingStaffProfile(userId);
    }

    match /users/{userId}/coopVerification/{docId} {
      allow read: if isAuthenticated();
      allow create, update: if isOwner(userId)
        || (isAuthenticated()
          && request.resource.data.orgId is string
          && isOrgManager(request.resource.data.orgId))
        || isSuperAdmin()
        || isAdmin();
      allow delete: if false;
    }

    match /buyerProfiles/{userId} {
      allow read: if isOwner(userId) || isSuperAdmin();
      allow write: if isOwner(userId);
    }

    match /userDirectory/{userId} {
      allow read: if isAuthenticated() && userRole() in ['org_admin', 'org_staff', 'admin', 'superadmin'];
      allow write: if isOwner(userId);
    }

    match /billingPlanTemplates/{planId} {
      allow read: if isAuthenticated() && resource.data.isPublic == true;
      allow write: if isAdmin() || isSuperAdmin();
    }

    // ========================================================================
    // ORGANIZATIONS
    // ========================================================================

    match /organizations/{orgId} {
      allow read: if isOrgMember(orgId) || isAdmin() || isSuperAdmin();
      allow create: if isAuthenticated()
        && request.resource.data.createdByUid == request.auth.uid;
      allow update, delete: if (isOrgMember(orgId) && isOrgProfileUpdate())
        || isAdmin()
        || (isSuperAdmin() && isOrgVerificationOnlyUpdate());

      match /members/{memberId} {
        allow read: if isOrgMember(orgId) || isAdmin() || isSuperAdmin();
        allow create, update: if isOrgMember(orgId)
          || isAdmin()
          || isSuperAdmin()
          || (isAuthenticated()
            && request.auth.uid == memberId
            && get(/databases/$(database)/documents/organizations/$(orgId)).data.createdByUid == request.auth.uid);
        allow delete: if isOrgAdmin(orgId) || isAdmin() || isSuperAdmin();
      }

      match /subscription/{subId} {
        allow read: if isOrgMember(orgId) || isAdmin() || isSuperAdmin();
        allow create, update, delete: if isOrgAdmin(orgId) || isAdmin() || isSuperAdmin();
      }
      match /memberAudit/{logId} {
        allow read: if isOrgMember(orgId) || isAdmin() || isSuperAdmin();
        allow create: if isOrgManager(orgId);
        allow update, delete: if false;
      }

    }

    match /orgs/{orgId} {
      allow read: if isOrgAffiliated(orgId);
      allow create: if isAuthenticated()
        && request.resource.data.createdByUid == request.auth.uid;
      allow update, delete: if (isOrgMember(orgId) && isOrgProfileUpdate())
        || isAdmin()
        || (isSuperAdmin() && isOrgVerificationOnlyUpdate());

      match /members/{memberId} {
        allow read: if (isOrgApproved(orgId) && (isOrgMember(orgId) || isAdmin() || isSuperAdmin()))
          || (isAuthenticated()
            && (request.auth.uid == memberId || resource.data.linkedUserUid == request.auth.uid || resource.data.userUid == request.auth.uid));
        allow create: if (isOrgApproved(orgId) && (isOrgAdmin(orgId) || isAdmin() || isSuperAdmin()))
          || (isOrgApproved(orgId)
            && isOrgStaff(orgId)
            && (!('status' in request.resource.data) || request.resource.data.status in ['draft', 'submitted'])
            && (!('verificationStatus' in request.resource.data) || request.resource.data.verificationStatus in ['draft', 'submitted'])
            && !request.resource.data.keys().hasAny(['verifiedBy', 'verifiedAt', 'rejectionReason', 'seatStatus', 'premiumSeatType', 'seatType', 'seatAssignedBy', 'seatAssignedAt']))
          || (isAuthenticated()
            && request.auth.uid == memberId
            && get(/databases/$(database)/documents/orgs/$(orgId)).data.createdByUid == request.auth.uid
            && request.resource.data.role == 'org_admin');
        allow update: if ((isOrgApproved(orgId) && (isOrgAdmin(orgId) || isAdmin() || isSuperAdmin()))
            && (!isSeatMutation() || isOrgAdmin(orgId) || canStaffManageBilling(orgId) || isAdmin() || isSuperAdmin()))
          || (isOrgAdmin(orgId)
            && request.resource.data.diff(resource.data)
              .affectedKeys()
              .hasOnly(['seatType', 'seatStatus', 'premiumSeatType', 'seatAssignedAt', 'seatAssignedBy', 'seatAssignedByName', 'updatedAt']))
          || (isOrgApproved(orgId)
            && isOrgStaff(orgId)
            && !isSeatMutation()
            && (!('status' in request.resource.data) || request.resource.data.status in ['draft', 'submitted'])
            && (!('verificationStatus' in request.resource.data) || request.resource.data.verificationStatus in ['draft', 'submitted'])
            && !request.resource.data.diff(resource.data)
              .affectedKeys()
              .hasAny(['verifiedBy', 'verifiedAt', 'verifiedByUid', 'verifiedByName', 'rejectionReason', 'seatStatus', 'premiumSeatType', 'seatType', 'seatAssignedBy', 'seatAssignedAt']));
        allow delete: if isOrgApproved(orgId) && isOrgManager(orgId);

        match /audit/{logId} {
          allow read: if (isOrgApproved(orgId) && isOrgMember(orgId)) || isAdmin() || isSuperAdmin();
          allow create: if isOrgApproved(orgId) && isOrgManager(orgId);
          allow update, delete: if false;
        }
      }

      match /memberApplications/{applicationId} {
        allow read: if isOrgApproved(orgId) && (isOrgAdmin(orgId) || isOrgStaff(orgId) || isAdmin() || isSuperAdmin());
        allow create: if isOrgApproved(orgId)
          && (isOrgAdmin(orgId) || isOrgStaff(orgId) || isAdmin() || isSuperAdmin())
          && request.resource.data.status == 'pending'
          && request.resource.data.submittedByUid == request.auth.uid;
        allow update: if (isOrgApproved(orgId) && (isOrgAdmin(orgId) || isAdmin() || isSuperAdmin())
            && request.resource.data.diff(resource.data)
              .affectedKeys()
              .hasOnly(['status', 'updatedAt', 'approvedByUid', 'approvedAt', 'rejectedByUid', 'rejectedAt', 'rejectionReason'])
            && request.resource.data.status in ['approved', 'rejected'])
          || (isOrgApproved(orgId) && (isOrgAdmin(orgId) || isOrgStaff(orgId) || isAdmin() || isSuperAdmin())
            && request.resource.data.diff(resource.data)
              .affectedKeys()
              .hasOnly(['memberUid', 'updatedAt']));
        allow delete: if false;
      }

      match /collections/{collectionId} {
        allow read, write: if (isOrgApproved(orgId) && isOrgMember(orgId)) || isAdmin() || isSuperAdmin();

        match /commitments/{memberId} {
          allow read, write: if (isOrgApproved(orgId) && isOrgMember(orgId)) || isAdmin() || isSuperAdmin();
        }

        match /deliveries/{deliveryId} {
          allow read, write: if (isOrgApproved(orgId) && isOrgMember(orgId)) || isAdmin() || isSuperAdmin();
        }
      }

            match /marketSnapshots/{snapshotId} {
        allow read, write: if (isOrgApproved(orgId) && isOrgMember(orgId)) || isAdmin() || isSuperAdmin();
      }

match /priceSnapshots/{snapshotId} {
        allow read, write: if (isOrgApproved(orgId) && isOrgMember(orgId)) || isAdmin() || isSuperAdmin();
      }

      match /priceSignals/{signalId} {
        allow read, write: if (isOrgApproved(orgId) && isOrgMember(orgId)) || isAdmin() || isSuperAdmin();
      }

      match /priceHistory/{docId} {
        allow read, write: if (isOrgApproved(orgId) && isOrgMember(orgId)) || isAdmin() || isSuperAdmin();
      }

      match /priceAlerts/{alertId} {
        allow read, write: if (isOrgApproved(orgId) && isOrgMember(orgId)) || isAdmin() || isSuperAdmin();
      }

      match /recommendations/{docId} {
        allow read, write: if (isOrgApproved(orgId) && isOrgMember(orgId)) || isAdmin() || isSuperAdmin();
      }

      match /trainings/{trainingId} {
        allow read, write: if (isOrgApproved(orgId) && isOrgMember(orgId)) || isAdmin() || isSuperAdmin();

        match /attendance/{memberId} {
          allow read, write: if (isOrgApproved(orgId) && isOrgMember(orgId)) || isAdmin() || isSuperAdmin();
        }
      }

      match /certificates/{certificateId} {
        allow read, write: if (isOrgApproved(orgId) && isOrgMember(orgId)) || isAdmin() || isSuperAdmin();
      }

      match /targets/{targetId} {
        allow read, write: if (isOrgApproved(orgId) && isOrgMember(orgId)) || isAdmin() || isSuperAdmin();

        match /progress/{memberId} {
          allow read, write: if (isOrgApproved(orgId) && isOrgMember(orgId)) || isAdmin() || isSuperAdmin();
        }

        match /rewards/{rewardId} {
          allow read, write: if (isOrgApproved(orgId) && isOrgMember(orgId)) || isAdmin() || isSuperAdmin();
        }
      }

      match /subscription/{docId} {
        allow read: if isOrgManager(orgId) || isAdmin() || isSuperAdmin();
        allow create: if isOrgAdmin(orgId) || isAdmin() || isSuperAdmin() || canStaffManageBilling(orgId);
        allow update, delete: if isOrgAdmin(orgId) || isAdmin() || isSuperAdmin() || canStaffManageBilling(orgId);
      }

      match /billing/settings {
        allow read: if isOrgManager(orgId) || isAdmin() || isSuperAdmin();
        allow create: if isOrgAdmin(orgId) || isAdmin() || isSuperAdmin() || canStaffManageBilling(orgId);
        allow update: if isOrgAdmin(orgId) || isAdmin() || isSuperAdmin() || canStaffManageBilling(orgId);
        allow delete: if false;
      }

      match /billing/seatLedger/{ledgerId} {
        allow read: if isOrgManager(orgId) || isAdmin() || isSuperAdmin();
        allow create: if isOrgAdmin(orgId) || canStaffManageBilling(orgId) || isAdmin() || isSuperAdmin();
        allow update, delete: if false;
      }

      match /billing/invoices/{invoiceId} {
        allow read: if isOrgManager(orgId) || isAdmin() || isSuperAdmin();
        allow write: if isOrgAdmin(orgId) || canStaffManageBilling(orgId) || isAdmin() || isSuperAdmin();
      }

      match /billing/payments/{paymentId} {
        allow read: if isOrgManager(orgId) || isAdmin() || isSuperAdmin();
        allow write: if isOrgAdmin(orgId) || canStaffManageBilling(orgId) || isAdmin() || isSuperAdmin();
      }

      match /settings/{docId} {
        allow read, write: if (isOrgApproved(orgId) && isOrgMember(orgId)) || isAdmin() || isSuperAdmin();
      }

      match /joinCodes/{code} {
        allow read: if isAuthenticated();
        allow create: if isOrgAdmin(orgId) || isOrgStaff(orgId) || isAdmin() || isSuperAdmin();
        allow update, delete: if isOrgAdmin(orgId) || isOrgStaff(orgId) || isAdmin() || isSuperAdmin();
      }
    }

    // ========================================================================
    // ORG MEMBERS (TOP-LEVEL)
    // ========================================================================

    match /orgMembers/{memberId} {
      allow read: if isAuthenticated()
        && (isAdmin() || isSuperAdmin() || isOrgAdmin(resource.data.orgId) || isOrgStaff(resource.data.orgId));
      allow create: if isAuthenticated()
        && (isAdmin()
          || isSuperAdmin()
          || isOrgAdmin(request.resource.data.orgId)
          || get(/databases/$(database)/documents/organizations/$(request.resource.data.orgId)).data.createdByUid
            == request.auth.uid);
      allow update, delete: if isAuthenticated()
        && (isAdmin() || isSuperAdmin() || isOrgAdmin(request.resource.data.orgId));
    }

    // ========================================================================
    // JOIN CODES
    // ========================================================================

    match /joinCodes/{code} {
      allow read: if true;
      allow create: if isAuthenticated()
        && (isOrgAdmin(request.resource.data.orgId) || isOrgStaff(request.resource.data.orgId));
      allow update, delete: if isAuthenticated()
        && (isOrgAdmin(resource.data.orgId) || isOrgStaff(resource.data.orgId));
    }

    match /orgJoinRequests/{requestId} {
      allow create: if isAuthenticated()
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.status == 'submitted';
      allow read: if isAuthenticated()
        && (resource.data.uid == request.auth.uid
          || isOrgAdmin(resource.data.orgId)
          || isOrgStaff(resource.data.orgId)
          || isAdmin()
          || isSuperAdmin());
      allow update: if isAuthenticated()
        && (isOrgAdmin(resource.data.orgId) || isAdmin() || isSuperAdmin())
        && request.resource.data.diff(resource.data)
          .affectedKeys()
          .hasOnly(['status', 'updatedAt', 'approvedByUid', 'approvedAt', 'rejectedByUid', 'rejectedAt', 'rejectionReason']);
      allow delete: if false;
    }

    // ========================================================================
    // FARMER PROFILES
    // ========================================================================

    match /farmers/{userId} {
      allow read, write: if isOwner(userId);
    }

    match /farmers/{userId}/pendingUpdates/{pendingId} {
      allow read, write: if isOwner(userId);
    }

    // ========================================================================
    // FARMS (CLIMATE LOCATIONS)
    // ========================================================================

    match /farms/{farmId} {
      allow create: if isAuthenticated()
        && request.resource.data.uid == request.auth.uid
        && isValidFarmCreate(request.resource.data);
      allow get: if isAuthenticated()
        && resource.data.uid == request.auth.uid;
      allow list: if isAuthenticated()
        && request.query.where("uid", "==", request.auth.uid);
      allow update: if isAuthenticated()
        && resource.data.uid == request.auth.uid
        && request.resource.data.uid == resource.data.uid;
      allow delete: if isAuthenticated()
        && resource.data.uid == request.auth.uid;
    }

    // ========================================================================
    // CLIMATE CACHE (READ ONLY)
    // ========================================================================

    match /climateCache/{cacheId} {
      allow read: if isAuthenticated() && resource.data.uid == request.auth.uid;
      allow write: if false;
    }

    // ========================================================================
    // MARKET PRICES CACHE (MARKET ORACLE AGENT)
    // ========================================================================

    match /market_prices/{priceId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated()
        && request.resource.data.keys().hasAll(['commodity', 'market', 'retail', 'wholesale', 'county', 'date', 'createdAt', 'updatedAt'])
        && request.resource.data.commodity is string
        && request.resource.data.market is string
        && request.resource.data.county is string
        && request.resource.data.retail is number
        && request.resource.data.wholesale is number
        && isValidTimestamp(request.resource.data.date)
        && isValidTimestamp(request.resource.data.createdAt)
        && isValidTimestamp(request.resource.data.updatedAt);
      allow delete: if isAuthenticated();
    }

    // ========================================================================
    // ALERT SUBSCRIPTIONS (PER USER)
    // ========================================================================

    match /alertSubscriptions/{userId} {
      allow read, write: if isOwner(userId);
    }

    match /alerts/{userId}/items/{alertId} {
      allow read, write: if isOwner(userId);
    }

    // ========================================================================
    // CROPS (SENTINEL AGENT)
    // ========================================================================

    match /crops/{cropId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if isOwner(request.resource.data.userId);
      allow update: if isOwner(resource.data.userId)
        && request.resource.data.userId == resource.data.userId;
      allow delete: if isOwner(resource.data.userId);
      allow list: if isAuthenticated();
    }

    // ========================================================================
    // MARKETPLACE LISTINGS
    // ========================================================================

    match /listings/{listingId} {
      // Authenticated users can read listings
      allow read: if isAuthenticated();

      // Only the authenticated seller can create their own listing with phone
      allow create: if isValidListingCreate();

      // Only allow review aggregate updates or pending edit requests
      allow update: if isListingReviewAggregateUpdate() || isListingPendingUpdateRequest();

      // Prevent direct deletes from client
      allow delete: if false;
    }

    match /cropActivities/{activityId} {
      allow read: if ownsCrop(resource.data.cropId);
      allow create: if ownsCrop(request.resource.data.cropId);
      allow update: if ownsCrop(resource.data.cropId);
      allow delete: if ownsCrop(resource.data.cropId);
      allow list: if isAuthenticated();
    }

    match /cropRecommendations/{recommendationId} {
      allow read: if ownsCrop(resource.data.cropId);
      allow create: if ownsCrop(request.resource.data.cropId);
      allow update: if ownsCrop(resource.data.cropId);
      allow delete: if ownsCrop(resource.data.cropId);
      allow list: if isAuthenticated();
    }

    match /cropGrowthData/{growthId} {
      allow read: if ownsCrop(resource.data.cropId);
      allow create: if ownsCrop(request.resource.data.cropId);
      allow update: if ownsCrop(resource.data.cropId);
      allow delete: if ownsCrop(resource.data.cropId);
      allow list: if isAuthenticated();
    }
    
    // ========================================================================
    // HARVEST SCHEDULES
    // ========================================================================
    
    match /users/{userId}/harvest/{harvestId}/schedules/{scheduleId} {
      
      // Read: Owner only
      allow read: if isOwner(userId);
      
      // Create: Owner only, with validation
      allow create: if isOwner(userId)
        && request.resource.data.userId == userId
        && request.resource.data.keys().hasAll(['cropId', 'farmId', 'cropName', 'field', 'plantedDate', 'estimatedReadyDate', 'status', 'expectedYield', 'yieldUnit'])
        && request.resource.data.status in ['Pending', 'Ready', 'InProgress', 'Harvested', 'Cancelled']
        && request.resource.data.expectedYield > 0
        && isValidTimestamp(request.resource.data.createdAt)
        && isValidTimestamp(request.resource.data.updatedAt);
      
      // Update: Owner only, preserve userId
      allow update: if isOwner(userId)
        && resource.data.userId == userId
        && request.resource.data.userId == userId
        && isValidTimestamp(request.resource.data.updatedAt);
      
      // Delete: Owner only
      allow delete: if isOwner(userId)
        && resource.data.userId == userId;
      
      // List
      allow list: if isOwner(userId);
    }
    
    // ========================================================================
    // WORKERS
    // ========================================================================
    
    match /users/{userId}/harvest/{harvestId}/workers/{workerId} {
      
      // Read: Owner only
      allow read: if isOwner(userId);
      
      // Create: Owner only, with validation
      allow create: if isOwner(userId)
        && request.resource.data.userId == userId
        && request.resource.data.keys().hasAll(['name', 'role', 'phone', 'status'])
        && request.resource.data.role in ['Harvester', 'Supervisor', 'Transporter', 'Quality Inspector']
        && request.resource.data.status in ['Active', 'Inactive']
        && request.resource.data.name.size() > 0
        && request.resource.data.phone.size() > 0
        && request.resource.data.assignedScheduleIds is list
        && isValidTimestamp(request.resource.data.createdAt)
        && isValidTimestamp(request.resource.data.updatedAt);
      
      // Update: Owner only, preserve userId
      allow update: if isOwner(userId)
        && resource.data.userId == userId
        && request.resource.data.userId == userId
        && isValidTimestamp(request.resource.data.updatedAt);
      
      // Delete: Owner only
      allow delete: if isOwner(userId)
        && resource.data.userId == userId;
      
      // List
      allow list: if isOwner(userId);
    }
    
    // ========================================================================
    // DELIVERIES
    // ========================================================================
    
    match /users/{userId}/harvest/{harvestId}/deliveries/{deliveryId} {
      
      // Read: Owner only
      allow read: if isOwner(userId);
      
      // Create: Owner only, with validation
      allow create: if isOwner(userId)
        && request.resource.data.userId == userId
        && request.resource.data.keys().hasAll(['scheduleId', 'assignedWorkerId', 'destination', 'destinationAddress', 'quantity', 'quantityUnit', 'scheduledDate', 'status', 'vehicleType'])
        && request.resource.data.destination in ['Market', 'Warehouse', 'Buyer', 'Processor', 'Other']
        && request.resource.data.status in ['Pending', 'InTransit', 'Delivered', 'Cancelled', 'Delayed']
        && request.resource.data.vehicleType in ['Truck', 'Van', 'Motorbike', 'Bicycle', 'Other']
        && request.resource.data.quantity > 0
        && isValidTimestamp(request.resource.data.createdAt)
        && isValidTimestamp(request.resource.data.updatedAt);
      
      // Update: Owner only, preserve userId
      allow update: if isOwner(userId)
        && resource.data.userId == userId
        && request.resource.data.userId == userId
        && isValidTimestamp(request.resource.data.updatedAt);
      
      // Delete: Owner only
      allow delete: if isOwner(userId)
        && resource.data.userId == userId;
      
      // List
      allow list: if isOwner(userId);
    }

    // ========================================================================
    // MARKETPLACE HELPERS
    // ========================================================================

    function isMarketplaceStatus(status) {
      return status in ['pending', 'accepted', 'in_transit', 'completed', 'cancelled'];
    }

    function isPositiveNumber(value) {
      return value is number && value > 0;
    }

    function hasOrderItems(data) {
      return ('items' in data) && data.items is list && data.items.size() > 0;
    }

    function hasValidOrderTotals(data) {
      return ('totalAmount' in data) && isPositiveNumber(data.totalAmount);
    }

    function hasValidOrderQuantity(data) {
      return !('quantity' in data) || isPositiveNumber(data.quantity);
    }

    function hasOrderItemsOrQuantity(data) {
      return hasOrderItems(data) || ('quantity' in data);
    }

    function hasValidTimestamps(data) {
      return isValidTimestamp(data.createdAt) && isValidTimestamp(data.updatedAt);
    }

    function isValidReviewRating(value) {
      return value is number && value >= 1 && value <= 5;
    }

    function isValidReviewComment(value) {
      return value is string && value.size() <= 500;
    }

    function isValidReviewCreate(listingId, buyerId) {
      let listing = get(/databases/$(database)/documents/listings/$(listingId)).data;
      return isAuthenticated()
        && listing != null
        && request.resource.data.listingId == listingId
        && request.resource.data.sellerId == listing.sellerId
        && request.resource.data.buyerId == buyerId
        && request.resource.data.buyerId == request.auth.uid
        && request.resource.data.buyerName is string
        && isValidReviewRating(request.resource.data.rating)
        && isValidReviewComment(request.resource.data.comment)
        && isValidTimestamp(request.resource.data.createdAt);
    }

    // ========================================================================
    // MARKETPLACE LISTINGS (APPENDED)
    // ========================================================================

    match /listings/{listingId} {
      // Authenticated users can read listings
      allow read: if isAuthenticated();

      // Only authenticated sellers can create their own listing
      allow create: if isValidListingCreate()
        && hasValidTimestamps(request.resource.data)
        && (!('quantity' in request.resource.data) || isPositiveNumber(request.resource.data.quantity));

      // Only allow review aggregate updates or pending edit requests
      allow update: if isListingReviewAggregateUpdate() || isListingPendingUpdateRequest();

      // Prevent direct deletes from client
      allow delete: if false;

      match /reviews/{buyerId} {
        allow read: if isAuthenticated();
        allow create: if isValidReviewCreate(listingId, buyerId);
        allow update, delete: if false;
      }
    }

    match /listingEdits/{editId} {
      allow read: if isAuthenticated() && resource.data.sellerId == request.auth.uid;
      allow create: if isValidListingEditCreate();
      allow update, delete: if false;
    }

    // ========================================================================
    // MARKETPLACE ORDERS (APPENDED)
    // ========================================================================

    match /orders/{orderId} {
      // Only buyer or seller can read orders
      allow read: if isAuthenticated()
        && (resource.data.buyerId == request.auth.uid || resource.data.sellerId == request.auth.uid);

      // Only authenticated buyers can create orders for themselves with valid data
      allow create: if isAuthenticated()
        && request.resource.data.buyerId == request.auth.uid
        && hasValidTimestamps(request.resource.data)
        && hasValidOrderTotals(request.resource.data)
        && hasValidOrderQuantity(request.resource.data)
        && hasOrderItemsOrQuantity(request.resource.data)
        && isMarketplaceStatus(request.resource.data.status);

      // Buyer or seller can update, but buyerId/sellerId/createdAt are immutable
      allow update: if isAuthenticated()
        && (resource.data.buyerId == request.auth.uid || resource.data.sellerId == request.auth.uid)
        && request.resource.data.buyerId == resource.data.buyerId
        && request.resource.data.sellerId == resource.data.sellerId
        && request.resource.data.createdAt == resource.data.createdAt
        && isValidTimestamp(request.resource.data.updatedAt)
        && hasValidOrderTotals(request.resource.data)
        && hasValidOrderQuantity(request.resource.data)
        && hasOrderItemsOrQuantity(request.resource.data)
        && isMarketplaceStatus(request.resource.data.status);

      // Orders cannot be deleted
      allow delete: if false;
    }
  }
}
